{"version":3,"sources":["../source/common.js"],"names":[],"mappings":"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","file":"common.js","sourcesContent":["import path from 'path'\r\nimport fs from 'fs'\r\n\r\nimport require_hacker from 'require-hacker'\r\n\r\nimport { is_object, exists, starts_with } from './helpers'\r\n\r\n// returns a stub for webpack-assets.json if it doesn't exist yet\r\n// (because node.js and webpack are being run in parallel in development mode)\r\nexport function default_webpack_assets()\r\n{\r\n\tconst webpack_assets = \r\n\t{\r\n\t\tjavascript: {},\r\n\t\tstyles: {},\r\n\t\tassets: {}\r\n\t}\r\n\r\n\treturn webpack_assets\r\n}\r\n\r\n// adds missing fields, etc\r\nexport function normalize_options(options)\r\n{\r\n\t// parameters check\r\n\tfor (let key of Object.keys(options))\r\n\t{\r\n\t\tswitch (key)\r\n\t\t{\r\n\t\t\tcase 'assets':\r\n\t\t\t\tif (!is_object(options[key]))\r\n\t\t\t\t{\r\n\t\t\t\t\tthrow new Error(`\"${key}\" configuration parameter must be ` + `an object`)\r\n\t\t\t\t}\r\n\t\t\t\tbreak\r\n\r\n\t\t\tcase 'debug':\r\n\t\t\t\tif (typeof options[key] !== 'boolean')\r\n\t\t\t\t{\r\n\t\t\t\t\tthrow new Error(`\"${key}\" configuration parameter must be ` + `a boolean`)\r\n\t\t\t\t}\r\n\t\t\t\tbreak\r\n\r\n\t\t\tcase 'webpack_assets_file_path':\r\n\t\t\tcase 'webpack_stats_file_path':\r\n\t\t\t\tif (typeof options[key] !== 'string')\r\n\t\t\t\t{\r\n\t\t\t\t\tthrow new Error(`\"${key}\" configuration parameter must be ` + `a string`)\r\n\t\t\t\t}\r\n\t\t\t\tbreak\r\n\r\n\t\t\tcase 'alias':\r\n\t\t\t\tif (!is_object(options[key]))\r\n\t\t\t\t{\r\n\t\t\t\t\tthrow new Error(`\"${key}\" configuration parameter must be ` + `an object`)\r\n\t\t\t\t}\r\n\t\t\t\tbreak\r\n\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error(`Unknown configuration parameter \"${key}\"`)\r\n\t\t}\r\n\t}\r\n\r\n\t// if no assets specified (for whatever reason), make it an empty array\r\n\tif (!options.assets)\r\n\t{\r\n\t\t// options.assets = {}\r\n\t\tthrow new Error('You must specify \"assets\" parameter in webpack-isomorphic-tools configuration')\r\n\t}\r\n\r\n\t// webpack-assets.json path, relative to the project base path\r\n\toptions.webpack_assets_file_path = options.webpack_assets_file_path || 'webpack-assets.json'\t\r\n\r\n\t// webpack-stats.json path, relative to the project base path\r\n\toptions.webpack_stats_file_path = options.webpack_stats_file_path || 'webpack-stats.json'\t\r\n\r\n\t// if Webpack aliases are supplied, validate them\r\n\tif (options.alias)\r\n\t{\r\n\t\tfor (let key of Object.keys(options.alias))\r\n\t\t{\r\n\t\t\tif (typeof options.alias[key] !== 'string')\r\n\t\t\t{\r\n\t\t\t\tthrow new Error(`Invalid alias for \"${key}\": \"${options.alias[key]}\"`)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// generate names (if required) for each user defined asset type, normalize extensions\r\n\tfor (let asset_type of Object.keys(options.assets))\r\n\t{\r\n\t\tconst description = options.assets[asset_type]\r\n\r\n\t\t// normalize extensions\r\n\t\tif (description.extension)\r\n\t\t{\r\n\t\t\t// sanity check\r\n\t\t\tif (Array.isArray(description.extension))\r\n\t\t\t{\r\n\t\t\t\tthrow new Error(`Use \"extensions\" key instead of \"extension\" for specifying an array of file extensions for assets of type \"${asset_type}\"`)\r\n\t\t\t}\r\n\r\n\t\t\t// sanity check\r\n\t\t\tif (typeof description.extension !== 'string')\r\n\t\t\t{\r\n\t\t\t\tthrow new Error(`\"extension\" value must be a string for assets of type \"${asset_type}\"`)\r\n\t\t\t}\r\n\r\n\t\t\t// normalize\r\n\t\t\tdescription.extensions = [description.extension]\r\n\t\t\tdelete description.extension\r\n\t\t}\r\n\r\n\t\t// sanity check\r\n\t\tif (!description.extensions)\r\n\t\t{\r\n\t\t\tthrow new Error(`You must specify file extensions for assets of type \"${asset_type}\"`)\r\n\t\t}\r\n\r\n\t\t// parameters check\r\n\t\tfor (let key of Object.keys(description))\r\n\t\t{\r\n\t\t\tswitch (key)\r\n\t\t\t{\r\n\t\t\t\tcase 'extensions':\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\tcase 'exclude':\r\n\t\t\t\tcase 'include':\r\n\t\t\t\t\tif (!Array.isArray(description[key]))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthrow new Error(`\"${key}\" must be an array for asset type \"${asset_type}\"`)\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (let clusion of description[key])\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (typeof clusion !== 'string' \r\n\t\t\t\t\t\t\t&& !(clusion instanceof RegExp)\r\n\t\t\t\t\t\t\t&& typeof clusion !== 'function')\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tthrow new Error(`Unsupported object type for exclusion/inclusion \"${clusion}\" for asset type \"${asset_type}\"`)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\tcase 'filter':\r\n\t\t\t\tcase 'parser':\r\n\t\t\t\tcase 'path':\r\n\t\t\t\t\tif (typeof description[key] !== 'function')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthrow new Error(`\"${key}\" must be a function for asset type \"${asset_type}\"`)\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tthrow new Error(`Unknown property \"${key}\" for asset type \"${asset_type}\"`)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// alias the path and require() the correct file if an alias is found\r\nexport function alias_hook(path, module, project_path, aliases, log)\r\n{\r\n\t// possibly alias the path\r\n\tconst aliased_path = alias(path, aliases)\r\n\r\n\t// return if an alias not found\r\n\tif (!aliased_path)\r\n\t{\r\n\t\treturn\r\n\t}\r\n\r\n\t// if an alias is found, require() the correct path\r\n\tlog.debug(`alias found for \"${path}\", resolving to path \"${aliased_path}\"`)\r\n\r\n\t// resolve the path to a real filesystem path (resolves `npm link`, etc)\r\n\tconst global_path = require_hacker.resolve(aliased_path, module)\r\n\tlog.debug(` global path for the aliased module is ${global_path}`)\r\n\r\n\tconst result = require(global_path)\r\n\t// log.debug(` the path was found`)\r\n\r\n\treturn require_hacker.to_javascript_module_source(result)\r\n}\r\n\r\n// alias the path provided the aliases map\r\nfunction alias(path, aliases)\r\n{\r\n\t// if it's a path to a file - don't interfere\r\n\tif (starts_with(path, '.') || starts_with(path, '/'))\r\n\t{\r\n\t\treturn\r\n\t}\r\n\r\n\t// extract module name from the path\r\n\tconst slash_index = path.indexOf('/')\r\n\tconst module_name = slash_index >= 0 ? path.substring(0, slash_index) : path\r\n\tconst rest = slash_index >= 0 ? path.substring(slash_index) : ''\r\n\r\n\t// find an alias\r\n\tconst alias = aliases[module_name]\r\n\r\n\t// if an alias is found, require() the correct path\r\n\tif (alias)\r\n\t{\r\n\t\treturn alias + rest\r\n\t}\r\n}\r\n\r\n// converts global asset path to local-to-the-project asset path\r\nexport function normalize_asset_path(global_asset_path, project_path)\r\n{\r\n\t// // if this path is outside project folder,\r\n\t// // return it as a global path\r\n\t// if (!starts_with(global_asset_path, project_path + path.sep))\r\n\t// {\r\n\t// \treturn global_asset_path\r\n\t// }\r\n\r\n\t// this path is inside project folder,\r\n\t// convert it to a relative path\r\n\r\n\t// asset path relative to the project folder\r\n\tlet asset_path = path.relative(project_path, global_asset_path)\r\n\r\n\t// for Windows:\r\n\t//\r\n\t// convert Node.js path to a correct Webpack path\r\n\tasset_path = asset_path.replace(/\\\\/g, '/')\r\n\t// add './' in the beginning if it's missing (for example, in case of Windows)\r\n\tif (asset_path.indexOf('.') !== 0)\r\n\t{\r\n\t\tasset_path = './' + asset_path\r\n\t}\r\n\r\n\treturn asset_path\r\n}\r\n\r\n// replaces inner node_modules with ~\r\nexport function webpack_path(asset_path)\r\n{\r\n\t// webpack has a shortcut from \"node_modules\"\r\n\tif (starts_with(asset_path, './node_modules/'))\r\n\t{\r\n\t\tasset_path = asset_path.replace('./node_modules/', './~/')\r\n\t}\r\n\r\n\treturn asset_path\r\n}"]}